powershell -noexit { Start-Job { <# https://docs.microsoft.com/en-us/azure-stack/hci/manage/diskspd-overview;# https://docs.microsoft.com/en-us/azure/virtual-machines/disks-benchmarks; https://docs.microsoft.com/en-us/troubleshoot/azure/virtual-machines/how-to-use-perfInsights; Download files;#> [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::TLS12; (New-Object System.Net.WebClient).DownloadFile('https://github.com/Microsoft/diskspd/releases/latest/download/DiskSpd.zip', 'C:\Program Files\Common Files\DiskSpd.zip'); (New-Object System.Net.WebClient).DownloadFile('https://aka.ms/perfinsightslatest', 'C:\Program Files\Common Files\PerfInsights.zip'); <# Expand zips#> Expand-Archive -LiteralPath 'C:\Program Files\Common Files\DiskSpd.zip' -DestinationPath 'C:\Program Files\Common Files\DiskSpd'; Expand-Archive -LiteralPath 'C:\Program Files\Common Files\PerfInsights.zip' -DestinationPath 'C:\Program Files\Common Files\PerfInsights'; <# PerfInsights benchmark#>& 'C:\Program Files\Common Files\PerfInsights\PerfInsights.exe' /run advanced xpns /d 900 /AcceptDisclaimerAndShareDiagnostics /sau /outputfolder 'C:\Program Files\Common Files\'; }; Start-Job { <# Run tests#> $vCPUS = $env:NUMBER_OF_PROCESSORS; & 'C:\Program Files\Common Files\DiskSpd\amd64\diskspd.exe' -c1024M -d120 -w100 -t"$vCPUs" -o128 -b512k -r -Sh -L "C:\Program Files\Common Files\testfile1.dat"; <# Maximum write IOPS#>& 'C:\Program Files\Common Files\PerfInsights\amd64\diskspd.exe' -c200G -w100 -b8K -F4 -r -o128 -W30 -d120 -Sh "C:\Program Files\Common Files\testfile2.dat"; <# Maximum read IOPS#>& 'C:\Program Files\Common Files\PerfInsights\amd64\diskspd.exe' -c200G -b4K -F4 -r -o128 -W7200 -d120 -Sh "C:\Program Files\Common Files\testfile3.dat"; <# Maximum throughput#>& 'C:\Program Files\Common Files\PerfInsights\amd64\diskspd.exe' -c200G -b64K -F4 -r -o128 -W7200 -d120 -Sh "C:\Program Files\Common Files\testfile4.dat"; } }
